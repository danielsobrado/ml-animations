import{r as l,j as e,e as _}from"./index-BmgLEcVh.js";import{P as k}from"./pause-Pw5n6zyp.js";import{P as S}from"./play-4PCPORJF.js";import{R as A}from"./rotate-ccw-DnC3UZWM.js";function C(){const[a,m]=l.useState(0),[n,r]=l.useState(!1),[h,y]=l.useState(0),[i,v]=l.useState(!1),p=["[CLS]","The","cat","sat","on","mat"],d=[{title:"Input Embeddings",description:"Each token embedding (768-d) enters the self-attention layer."},{title:"Linear Projections",description:"Project embeddings to Q, K, V matrices. For each head: 768 ‚Üí 64 dimensions."},{title:"Compute Attention Scores",description:"Score = Q √ó K·µÄ / ‚àöd‚Çñ. Each token queries all other tokens to determine relevance."},{title:"Apply Softmax",description:"Softmax normalizes scores to attention weights (sum to 1 for each query token)."},{title:"Weighted Sum of Values",description:"Output = attention_weights √ó V. Aggregate information based on relevance."},{title:"Concatenate Heads",description:"Concat all 12 heads (12 √ó 64 = 768), then project with W·¥º back to 768-d."}],c=[{name:"Position",description:"Attends to nearby tokens",pattern:(t,s)=>1-Math.abs(t-s)*.2},{name:"[CLS] Focus",description:"All tokens attend to [CLS]",pattern:(t,s)=>s===0?.8:.1},{name:"Syntax",description:"Subject-verb relationships",pattern:(t,s)=>t===1&&s===3||t===3&&s===1?.9:.15},{name:"Self",description:"Token attends to itself",pattern:(t,s)=>t===s?.7:.15}];l.useEffect(()=>{if(n){const t=setInterval(()=>{m(s=>s>=d.length-1?(r(!1),s):s+1)},3e3);return()=>clearInterval(t)}},[n]);const w=()=>{m(0),r(!1)},f=({pattern:t,title:s,size:j="large"})=>{const o=j==="large"?"w-10 h-10":"w-6 h-6",g=j==="large"?"text-xs":"text-[8px]";return e.jsxs("div",{className:"inline-block",children:[s&&e.jsx("p",{className:"text-xs text-gray-400 mb-1 text-center",children:s}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`${o}`}),p.map((u,x)=>e.jsx("div",{className:`${o} ${g} flex items-center justify-center text-gray-500 font-mono`,children:u.slice(0,3)},x))]}),p.map((u,x)=>e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:`${o} ${g} flex items-center justify-center text-gray-500 font-mono`,children:u.slice(0,3)}),p.map((L,N)=>{const b=t(x,N);return e.jsx("div",{className:`${o} flex items-center justify-center ${g} rounded-sm m-0.5`,style:{backgroundColor:`rgba(234, 179, 8, ${b})`,color:b>.5?"black":"white"},children:j==="large"?b.toFixed(2):""},N)})]},x))]})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"text-3xl font-bold mb-2",children:["Multi-Head Self-Attention in ",e.jsx("span",{className:"text-yellow-400",children:"BERT"})]}),e.jsx("p",{className:"text-gray-400",children:"12 attention heads (BERT-Base) learn different types of relationships"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-3",children:[e.jsxs("button",{onClick:()=>r(!n),className:"flex items-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors",children:[n?e.jsx(k,{size:18}):e.jsx(S,{size:18}),n?"Pause":"Play Animation"]}),e.jsxs("button",{onClick:w,className:"flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors",children:[e.jsx(A,{size:18}),"Reset"]}),e.jsxs("button",{onClick:()=>v(!i),className:`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${i?"bg-purple-600":"bg-white/10 hover:bg-white/20"}`,children:[e.jsx(_,{size:18}),i?"Single Head":"All Heads"]})]}),e.jsx("div",{className:"flex flex-wrap justify-center gap-2",children:d.map((t,s)=>e.jsxs("button",{onClick:()=>{m(s),r(!1)},className:`px-3 py-1 rounded-full text-sm transition-all ${s===a?"bg-yellow-500 text-black":s<a?"bg-yellow-900 text-yellow-300":"bg-white/10 text-gray-500"}`,children:[s+1,". ",t.title]},s))}),e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-500/30 rounded-xl p-4",children:[e.jsxs("h3",{className:"font-bold text-yellow-400",children:["Step ",a+1,": ",d[a].title]}),e.jsx("p",{className:"text-gray-300 mt-1",children:d[a].description})]}),e.jsxs("div",{className:"bg-black/30 rounded-2xl p-6 border border-white/10 overflow-x-auto",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4 mb-8 min-w-max",children:[e.jsx("div",{className:`text-center transition-all duration-500 ${a>=0?"opacity-100":"opacity-30"}`,children:e.jsxs("div",{className:"bg-blue-600/30 border border-blue-500 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm font-medium text-blue-300",children:"Input"}),e.jsx("p",{className:"text-xs text-gray-400",children:"[6, 768]"})]})}),e.jsx("span",{className:"text-gray-500",children:"‚Üí"}),e.jsxs("div",{className:`text-center transition-all duration-500 ${a>=1?"opacity-100":"opacity-30"}`,children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"bg-red-600/30 border border-red-500 rounded-lg p-2",children:e.jsx("p",{className:"text-xs text-red-300",children:"Q"})}),e.jsx("div",{className:"bg-green-600/30 border border-green-500 rounded-lg p-2",children:e.jsx("p",{className:"text-xs text-green-300",children:"K"})}),e.jsx("div",{className:"bg-purple-600/30 border border-purple-500 rounded-lg p-2",children:e.jsx("p",{className:"text-xs text-purple-300",children:"V"})})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"[6, 12, 64]"})]}),e.jsx("span",{className:"text-gray-500",children:"‚Üí"}),e.jsx("div",{className:`text-center transition-all duration-500 ${a>=2?"opacity-100":"opacity-30"}`,children:e.jsxs("div",{className:"bg-orange-600/30 border border-orange-500 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm font-medium text-orange-300",children:"Q√óK·µÄ/‚àö64"}),e.jsx("p",{className:"text-xs text-gray-400",children:"[6, 6]"})]})}),e.jsx("span",{className:"text-gray-500",children:"‚Üí"}),e.jsx("div",{className:`text-center transition-all duration-500 ${a>=3?"opacity-100":"opacity-30"}`,children:e.jsxs("div",{className:"bg-yellow-600/30 border border-yellow-500 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm font-medium text-yellow-300",children:"Softmax"}),e.jsx("p",{className:"text-xs text-gray-400",children:"weights"})]})}),e.jsx("span",{className:"text-gray-500",children:"‚Üí"}),e.jsx("div",{className:`text-center transition-all duration-500 ${a>=4?"opacity-100":"opacity-30"}`,children:e.jsxs("div",{className:"bg-teal-600/30 border border-teal-500 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm font-medium text-teal-300",children:"Attn √ó V"}),e.jsx("p",{className:"text-xs text-gray-400",children:"[6, 64]"})]})}),e.jsx("span",{className:"text-gray-500",children:"‚Üí"}),e.jsx("div",{className:`text-center transition-all duration-500 ${a>=5?"opacity-100":"opacity-30"}`,children:e.jsxs("div",{className:"bg-pink-600/30 border border-pink-500 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm font-medium text-pink-300",children:"Concat + W·¥º"}),e.jsx("p",{className:"text-xs text-gray-400",children:"[6, 768]"})]})})]}),a>=2&&e.jsx("div",{className:"mt-6",children:i?e.jsxs("div",{children:[e.jsx("h4",{className:"text-center text-gray-400 mb-4",children:"All 12 Attention Heads (showing 4 representative patterns)"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 justify-items-center",children:c.map((t,s)=>e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm text-yellow-400 mb-1",children:["Head ",s+1,": ",t.name]}),e.jsx(f,{pattern:t.pattern,size:"small"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.description})]},s))})]}):e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"flex gap-2 mb-4",children:c.map((t,s)=>e.jsx("button",{onClick:()=>y(s),className:`px-3 py-1 rounded text-sm transition-all ${h===s?"bg-yellow-500 text-black":"bg-white/10 hover:bg-white/20"}`,children:t.name},s))}),e.jsx(f,{pattern:c[h].pattern,title:`Attention Pattern: ${c[h].description}`})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-black/30 rounded-xl p-4 border border-white/10",children:[e.jsx("h4",{className:"font-bold text-yellow-400 mb-3",children:"üß† Why Multiple Heads?"}),e.jsxs("ul",{className:"text-sm text-gray-300 space-y-2",children:[e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-green-400",children:"‚úì"}),e.jsx("span",{children:"Different heads learn different patterns (syntax, semantics, position)"})]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-green-400",children:"‚úì"}),e.jsx("span",{children:"Parallel computation - all heads process simultaneously"})]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-green-400",children:"‚úì"}),e.jsx("span",{children:"Low-rank approximation: 12 √ó 64 = 768, but more expressive"})]}),e.jsxs("li",{className:"flex gap-2",children:[e.jsx("span",{className:"text-green-400",children:"‚úì"}),e.jsx("span",{children:"Redundancy provides robustness"})]})]})]}),e.jsxs("div",{className:"bg-black/30 rounded-xl p-4 border border-white/10",children:[e.jsx("h4",{className:"font-bold text-purple-400 mb-3",children:"üìä BERT Attention Stats"}),e.jsx("table",{className:"w-full text-sm",children:e.jsxs("tbody",{children:[e.jsxs("tr",{className:"border-b border-white/10",children:[e.jsx("td",{className:"py-2 text-gray-400",children:"Number of heads"}),e.jsx("td",{className:"py-2 text-right font-mono",children:"12 (Base) / 16 (Large)"})]}),e.jsxs("tr",{className:"border-b border-white/10",children:[e.jsx("td",{className:"py-2 text-gray-400",children:"Head dimension (d‚Çñ)"}),e.jsx("td",{className:"py-2 text-right font-mono",children:"64"})]}),e.jsxs("tr",{className:"border-b border-white/10",children:[e.jsx("td",{className:"py-2 text-gray-400",children:"Total dimension"}),e.jsx("td",{className:"py-2 text-right font-mono",children:"768 (Base) / 1024 (Large)"})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"py-2 text-gray-400",children:"Attention layers"}),e.jsx("td",{className:"py-2 text-right font-mono",children:"12 (Base) / 24 (Large)"})]})]})})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-900/30 to-green-900/30 rounded-xl p-4 border border-blue-500/30",children:[e.jsx("h4",{className:"font-bold text-blue-400 mb-3",children:"üîÑ Bidirectional Attention (BERT's Key Innovation)"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-300 mb-2",children:"GPT (Unidirectional):"}),e.jsx("div",{className:"flex gap-1",children:["The","cat","sat","on"].map((t,s)=>e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"px-2 py-1 bg-gray-700 rounded text-xs",children:t}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["sees: ",["The","cat","sat","on"].slice(0,s+1).join(", ")]})]},s))}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Each token only sees tokens to its left"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-300 mb-2",children:"BERT (Bidirectional):"}),e.jsx("div",{className:"flex gap-1",children:["The","cat","sat","on"].map((t,s)=>e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"px-2 py-1 bg-yellow-700 rounded text-xs",children:t}),e.jsx("div",{className:"text-xs text-yellow-500 mt-1",children:"sees: all tokens"})]},s))}),e.jsx("p",{className:"text-xs text-yellow-500 mt-2",children:"Each token sees ALL other tokens (full context)"})]})]})]}),e.jsxs("div",{className:"bg-black/40 rounded-xl p-4 border border-white/10",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-3",children:"üêç PyTorch Multi-Head Attention:"}),e.jsx("pre",{className:"text-sm overflow-x-auto",children:e.jsx("code",{className:"text-green-300",children:`class MultiHeadAttention(nn.Module):
    def __init__(self, hidden_size=768, num_heads=12):
        super().__init__()
        self.num_heads = num_heads
        self.head_dim = hidden_size // num_heads  # 64
        
        # Q, K, V projections
        self.query = nn.Linear(hidden_size, hidden_size)
        self.key = nn.Linear(hidden_size, hidden_size)
        self.value = nn.Linear(hidden_size, hidden_size)
        # Output projection
        self.out = nn.Linear(hidden_size, hidden_size)
        
    def forward(self, x, attention_mask=None):
        B, L, _ = x.shape  # batch, length, hidden_size
        
        # Project to Q, K, V
        Q = self.query(x).view(B, L, self.num_heads, self.head_dim).transpose(1, 2)
        K = self.key(x).view(B, L, self.num_heads, self.head_dim).transpose(1, 2)
        V = self.value(x).view(B, L, self.num_heads, self.head_dim).transpose(1, 2)
        # Shape: [B, num_heads, L, head_dim]
        
        # Attention scores
        scores = torch.matmul(Q, K.transpose(-2, -1)) / math.sqrt(self.head_dim)
        
        # Apply mask (for padding)
        if attention_mask is not None:
            scores = scores.masked_fill(attention_mask == 0, -1e9)
        
        # Softmax and weighted sum
        attn_weights = F.softmax(scores, dim=-1)
        context = torch.matmul(attn_weights, V)  # [B, num_heads, L, head_dim]
        
        # Concatenate heads and project
        context = context.transpose(1, 2).contiguous().view(B, L, -1)
        return self.out(context)  # [B, L, 768]`})})]})]})}export{C as default};
