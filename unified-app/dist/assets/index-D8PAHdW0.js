import{r as m,j as e,R as _}from"./index-CsxpOLHd.js";import{S as F,C as O,h as q,W as D,A as H,i as K,T as V,j as S,a as R,k as J,P as Q,M as U,l as X}from"./three.module-CNl0Zq82.js";import{g as L}from"./index-C8pce-KX.js";function Y({numExperts:o,topK:x,batchSize:i,onGenerate:p}){const t=m.useRef(null),w=m.useRef(null),u=m.useRef(null),[b,j]=m.useState(!1);m.useEffect(()=>{if(!t.current)return;const l=t.current.clientWidth,c=500,s=new F;s.background=new O(988970),w.current=s;const n=new q(75,l/c,.1,1e3);n.position.z=50,n.position.y=10;const a=new D({antialias:!0,alpha:!0});a.setSize(l,c),t.current.appendChild(a.domElement),u.current=a;const h=new H(16777215,.5);s.add(h);const f=new K(16777215,1);f.position.set(20,20,20),s.add(f);const g=new V(5,.5,16,100),N=new S({color:62463,emissive:62463,emissiveIntensity:.5}),d=new R(g,N);d.position.set(0,0,0),s.add(d);const k=25,y=[16711935,65439,12325886,16771584,16711765,52479,16750848,10092288];for(let v=0;v<o;v++){const A=v/o*Math.PI*2,T=Math.cos(A)*k,z=Math.sin(A)*k*.5,B=-20,P=new J(4,6,2),I=new S({color:y[v%y.length],transparent:!0,opacity:.8}),M=new R(P,I);M.position.set(T,z,B);const W=new Q(3,1),$=new U({color:16777215}),G=new R(W,$);G.position.set(0,4,0),M.add(G),s.add(M)}let E;const C=()=>{E=requestAnimationFrame(C),d.rotation.z+=.01,a.render(s,n)};return C(),()=>{var v;cancelAnimationFrame(E),a.dispose(),(v=t.current)!=null&&v.contains(a.domElement)&&t.current.removeChild(a.domElement)}},[o]);const r=()=>{if(b||!w.current)return;j(!0),p&&p();const l=w.current,c=[];for(let s=0;s<i;s++){const n=new X(.8,16,16),a=new S({color:16777215}),h=new R(n,a);h.position.set(0,-20-s*2,10),l.add(h),c.push(h);const f=L.timeline();f.to(h.position,{x:0,y:0,z:0,duration:1,ease:"power2.out",delay:s*.1});const g=[];for(;g.length<x;){const d=Math.floor(Math.random()*o);g.includes(d)||g.push(d)}l.children.find(d=>d.geometry.type==="BoxGeometry"&&l.children.indexOf(d)>2+g[0]);const N=l.children.filter(d=>d.geometry.type==="BoxGeometry");g.forEach((d,k)=>{const y=N[d];k===0&&(f.to(h.position,{x:y.position.x,y:y.position.y,z:y.position.z,duration:1,ease:"power2.inOut",onComplete:()=>{L.to(y.material,{emissive:16777215,duration:.1,yoyo:!0,repeat:1})}}),f.to(h.material,{opacity:0,duration:.5,delay:.5}))})}setTimeout(()=>{j(!1),c.forEach(s=>l.remove(s))},(i*.1+3)*1e3)};return e.jsxs("div",{className:"relative w-full h-full bg-slate-900 rounded-xl overflow-hidden border border-slate-700 shadow-2xl",children:[e.jsx("div",{ref:t,className:"w-full h-[500px]"}),e.jsxs("div",{className:"absolute bottom-4 left-4 right-4 flex justify-between items-center pointer-events-none",children:[e.jsxs("div",{className:"bg-slate-800/80 backdrop-blur p-4 rounded-lg border border-slate-600 pointer-events-auto",children:[e.jsx("h3",{className:"text-neon-blue font-bold mb-2",children:"Router Visualization"}),e.jsxs("p",{className:"text-sm text-slate-300 max-w-xs",children:["Tokens (white spheres) enter the Router (ring) and are dispatched to the Top-",x," Experts (colored boxes) based on learned gating weights."]})]}),e.jsx("button",{onClick:r,disabled:b,className:`pointer-events-auto px-6 py-3 rounded-lg font-bold text-black transition-all transform hover:scale-105 ${b?"bg-gray-500 cursor-not-allowed":"bg-neon-green hover:bg-white shadow-[0_0_15px_rgba(0,255,159,0.5)]"}`,children:b?"Routing...":"Generate Batch"})]})]})}function Z({numExperts:o,topK:x}){const i=m.useRef(null);return m.useEffect(()=>{const p=i.current;if(!p)return;const t=p.getContext("2d"),u=Array.from({length:o},()=>Math.random()*5).map(n=>Math.exp(n)),b=u.reduce((n,a)=>n+a,0),j=u.map(n=>n/b),r=j.map((n,a)=>({p:n,i:a})).sort((n,a)=>a.p-n.p).slice(0,x).map(n=>n.i),l=p.width,c=p.height,s=l/o;t.clearRect(0,0,l,c),j.forEach((n,a)=>{const h=r.includes(a),f=a*s,g=n*c*.8,N=c-g;t.fillStyle=h?"#00f3ff":"#334155",t.fillRect(f+2,N,s-4,g),t.fillStyle="#94a3b8",t.font="10px monospace",t.fillText(`E${a}`,f+s/2-6,c-5),h&&(t.fillStyle="#ffffff",t.fillText(n.toFixed(2),f+2,N-5))})},[o,x]),e.jsxs("div",{className:"bg-slate-900 p-4 rounded-lg border border-slate-800",children:[e.jsx("h3",{className:"text-sm font-bold text-slate-400 mb-2 uppercase",children:"Gating Probabilities"}),e.jsx("canvas",{ref:i,width:300,height:100,className:"w-full h-24"})]})}function ee({numExperts:o,loads:x}){const i=Math.max(...x||[1]);return e.jsxs("div",{className:"bg-slate-900 p-6 rounded-xl border border-slate-800",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Expert Load"}),e.jsx("div",{className:"space-y-2",children:Array.from({length:o}).map((p,t)=>{const w=x?x[t]:0,u=w/i*100||0;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-mono w-6 text-slate-500",children:["E",t]}),e.jsx("div",{className:"flex-1 h-2 bg-slate-800 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all duration-500 ${u>90?"bg-red-500":"bg-neon-green"}`,style:{width:`${u}%`}})}),e.jsx("span",{className:"text-xs text-slate-500 w-8 text-right",children:w})]},t)})}),e.jsx("p",{className:"text-xs text-slate-500 mt-4",children:"*Red indicates potential bottleneck (Expert Collapse risk)"})]})}function ae(){const[o,x]=m.useState(8),[i,p]=m.useState(2),[t,w]=m.useState(10),[u,b]=m.useState(Array(8).fill(0)),j=()=>{const r=[...u];for(let l=0;l<t;l++)for(let c=0;c<i;c++){const s=Math.floor(Math.random()*o);r[s]++}b(r)};return _.useEffect(()=>{b(Array(o).fill(0))},[o]),e.jsxs("div",{className:"text-slate-200",children:[e.jsx("header",{className:"max-w-7xl mx-auto mb-8 flex justify-end items-end",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"bg-slate-900 p-4 rounded-lg border border-slate-800",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase mb-1",children:"Experts"}),e.jsx("div",{className:"flex gap-2",children:[4,8,16].map(r=>e.jsx("button",{onClick:()=>x(r),className:`px-3 py-1 rounded text-sm font-bold transition-colors ${o===r?"bg-neon-blue text-black":"bg-slate-800 hover:bg-slate-700"}`,children:r},r))})]}),e.jsxs("div",{className:"bg-slate-900 p-4 rounded-lg border border-slate-800",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase mb-1",children:"Top-K"}),e.jsx("div",{className:"flex gap-2",children:[1,2].map(r=>e.jsx("button",{onClick:()=>p(r),className:`px-3 py-1 rounded text-sm font-bold transition-colors ${i===r?"bg-neon-pink text-black":"bg-slate-800 hover:bg-slate-700"}`,children:r},r))})]})]})}),e.jsxs("main",{className:"max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 aspect-video",children:e.jsx(Y,{numExperts:o,topK:i,batchSize:t,onGenerate:j})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-900 p-6 rounded-xl border border-slate-800",children:[e.jsxs("h2",{className:"text-xl font-bold text-white mb-4 flex items-center gap-2",children:[e.jsx("span",{className:"w-2 h-8 bg-neon-green rounded-full"}),"How it Works"]}),e.jsxs("div",{className:"space-y-4 text-sm text-slate-400",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"1. The Router:"})," A learned gating network that predicts which experts are best suited for each token."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"2. Sparse Activation:"})," Instead of using all parameters (Dense), we only use the Top-",i," experts. This saves massive compute."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-white",children:"3. Load Balancing:"})," Ideally, tokens are spread evenly. If one expert gets too many, it becomes a bottleneck (Expert Collapse)."]})]}),e.jsx("div",{className:"mt-6",children:e.jsx(Z,{numExperts:o,topK:i})})]}),e.jsx(ee,{numExperts:o,loads:u})]})]})]})}export{ae as default};
